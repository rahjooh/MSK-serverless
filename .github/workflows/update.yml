name: Update

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  TERRAFORM_VERSION: 1.6.6
  TF_VARS_FILE: ci.auto.tfvars
  TF_BACKEND_FILE: backend.auto.tfbackend

jobs:
  update:
    name: Import existing AWS resources into Terraform state
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Load Terraform configuration
        run: python3 scripts/load_terraform_config.py
        env:
          TERRAFORM_TFVARS: ${{ secrets.TERRAFORM_TFVARS }}

      - name: Validate backend config (skip invalid)
        if: ${{ hashFiles(env.TF_BACKEND_FILE) != '' }}
        run: |
          set -euo pipefail
          FILE="${TF_BACKEND_FILE}"
          if ! grep -Eq '^[[:space:]]*(bucket|key)[[:space:]]*=' "$FILE"; then
            echo "::notice::Invalid backend config in $FILE; removing so init can use default/backend args."
            rm -f "$FILE"
          fi

      - name: Read backend from versions.tf (fallback)
        if: ${{ hashFiles(env.TF_BACKEND_FILE) == '' }}
        run: |
          python3 - <<'PY'
          import os, re, sys
          path = 'versions.tf'
          if not os.path.isfile(path):
              sys.exit(0)
          content = open(path, 'r', encoding='utf-8').read()
          m = re.search(r'backend\s+"s3"\s*\{', content)
          if not m:
              sys.exit(0)
          i = m.end()
          depth = 1
          kv = {}
          while i < len(content) and depth > 0:
              ch = content[i]
              if ch == '{':
                  depth += 1
              elif ch == '}':
                  depth -= 1
              i += 1
              if depth == 0:
                  break
          block = content[m.end():i-1]
          for raw in block.splitlines():
              line = raw.split('#',1)[0].strip()
              if not line or '=' not in line:
                  continue
              k, v = line.split('=', 1)
              k = k.strip()
              v = v.strip().strip('"')
              if k in {'bucket','key','region','dynamodb_table'}:
                  kv[k] = v
          env_path = os.environ.get('GITHUB_ENV')
          if env_path:
              with open(env_path, 'a', encoding='utf-8') as fh:
                  if 'bucket' in kv:
                      fh.write(f"TF_BACKEND_BUCKET={kv['bucket']}\n")
                  if 'key' in kv:
                      fh.write(f"TF_BACKEND_KEY={kv['key']}\n")
                  if 'region' in kv:
                      fh.write(f"TF_BACKEND_REGION={kv['region']}\n")
                  if 'dynamodb_table' in kv:
                      fh.write(f"TF_BACKEND_DYNAMODB_TABLE={kv['dynamodb_table']}\n")
          PY

      - name: Configure AWS credentials (assume role)
        if: ${{ env.AWS_ASSUME_ROLE_ARN != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ASSUME_ROLE_ARN }}
          aws-region: ${{ env.TF_BACKEND_REGION || env.AWS_REGION_EFFECTIVE }}
          role-duration-seconds: 3600
          role-skip-session-tagging: true
          aws-access-key-id: ''
          aws-secret-access-key: ''
          aws-session-token: ''

      - name: Validate AWS credential configuration
        if: ${{ env.AWS_ASSUME_ROLE_ARN == '' }}        run: |
          echo "::error::Set assume_role_arn in the TERRAFORM_TFVARS secret so the update workflow can assume AWS credentials."

      - name: Show Terraform version
        run: terraform version

      - name: Preflight AWS identity
        run: |
          echo "Region: ${AWS_REGION_EFFECTIVE:-$AWS_REGION}"
          aws sts get-caller-identity

      - name: Update remote Terraform state
        run: bash scripts/rebuild-tfstate.sh
        env:
          # Prevent provider-level re-assume during CI state rebuild, but only for
          # commands that accept -var (avoid breaking init/import)
          TF_CLI_ARGS_apply: -var=assume_role_arn=""
          TF_CLI_ARGS_plan: -var=assume_role_arn=""
          STATE_DEBUG: 1
